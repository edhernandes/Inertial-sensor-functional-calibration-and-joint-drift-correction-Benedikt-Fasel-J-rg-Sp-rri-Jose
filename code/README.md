# Inertial Sensor Functional Calibration and Joint Drift Correction
Here you can find the code to functionally align inertial sensors to their respective segments. In a second step the segments' orientations are computed based on strapdown integration with static and joint drift correction. This algorithm is an extension of the code presented in [CodeOcean: Functional calibration for trunk and lower limb fixed inertial sensors](https://codeocean.com/2017/07/13/functional-calibration-for-trunk-and-lower-limb-fixed-inertial-sensors/). New in this algorithm is the calibration of the head and upper limb sensors, initial azimuth correction for the strapdown, and the joint drift correction algorithm. The functional calibration (trunk and lower limb segments) and joint drift correction has been explained and validated in Fasel B, Spörri J, Schütz P, Lorenzetti S, & Aminian K (2017). *Validation of functional calibration and strap-down joint drift correction for computing 3D joint angles of knee, hip, and trunk in alpine skiing*. PLOS ONE, DOI 10.1371/journal.pone.0181446. 
The set of calibration movements to perform for aligning trunk, lower limb, and upper limb sensors with their respecitve segment functional axes along with illustrative videos can be found on protocols.io under the DOI dx.doi.org/10.17504/protocols.io.jzncp5e. The functional calibration for the upper limb sensors and the initial azimuth correction are published in Fasel B, Spörri J, Schütz P, Lorenzetti S & Aminian K (2017). *An inertial sensor-based method for estimating the athlete's relative jonit center positions and center of mass kinamtics in alpine ski racing*. Frontiers in Physiology, DOI 10.3389/fphys.2017.00850.

> Note that the calibration movements have been initially proposed for in-field motion capture of alpine ski racing. However, the functional calibration can also be applied to any other domain as long as the person is able to well perform the required calibration movements.

## Structure

### Data
The inertial data of all sensors is stored in `/data/imuData.mat`. The data is already synchronized and accelerometer offset and sensitivity and gyroscope offset has been corrected according to Ferraris F, Grimaldi U, & Parvis M (1995). *Procedure for effortless in-field calibration of three-axis rate gyros and accelerometers*. Sensors and Materials, 7(5), 311–30. `imuData.mat` contains the variables, `fs` (sampling frequency in Hz), `leftShank` (inertial data from the sensor fixed to the left shank), `leftThigh`, `rightShank`, `rightThigh`, `sacrum`, `sternum`, `head`, `leftArm`, `leftWrist` (e.g. left forearm), `rightArm`, `rightWrist`. The inertial data is stored as a structure with the fields `acc` (acceleration, in g) and `gyr` (angular velocity, in deg/sec). All data is stored in N-by-3 matrices where N is the total number of samples and the columns are the sensing axes. The axes of the accelerometer and gyroscope are aligned and form a right-handed system.

The calibration movements have been segmented manually, i.e. the sample number of the first and last sample of each calibration movement was extracted manually. When segmenting the data it is important to have at least 0.5 sec (better 1 sec) of motionless at the beginning and end. The segmentation info is stored in `/data/calibInfo.mat`. This file additionally contains two more variables, `skiing_start` and `skiing_stop` which provides segmentation information for straight walking and can be used for further illustration.

> Indications on how to perform the calibration movements can be found on protocols.io under DOI 10.17504/protocols.io.itrcem6 and 10.17504/protocols.io.jzncp5e. The raw data presented here comes from a different set of measurements performed with an athlete, where after the calibration movements the athlete skied for approximately 2 minutes on an indoor skiing carpet.

### Code
The main functions of the code are located in the root directory `/code`. A separate function has been provided for calibrating each segment. The folder `/code/lib` contains a collection of small, useful functions for the quaternion algebra, orientation transforms, and filtering. Please refer directly to the function `main.m` to obtain detailed information about the different processing steps.

> After calibration all functional frames are following the ISB recommendations according to Wu G & Cavanagh PR (1995). *ISB Recommendations in the Reporting for Standardization of Kinematic Data*. Journal of Biomechanics, 28(10), 1257–1261.

### Output
For illustration purposes three graphs are stored showing the calibrated inertial data for the left leg and the knee angle computed during the squats.